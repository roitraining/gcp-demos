
<!doctype html>

<html>
<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <meta name="theme-color" content="#4F7DC9">
  <meta charset="UTF-8">
  <title>Do-It-Now activities (gcp-demos)</title>
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Code+Pro:400|Roboto:400,300,400italic,500,700|Roboto+Mono">
  <link rel="stylesheet" href="//fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://storage.googleapis.com/codelab-elements-tmp/codelab-elements.css">
  <style>
    .success {
      color: #1e8e3e;
    }
    .error {
      color: red;
    }
  </style>
</head>
<body>
  <google-codelab-analytics gaid="UA-49880327-14" ga4id=""></google-codelab-analytics>
  <google-codelab codelab-gaid=""
                  codelab-ga4id=""
                  id="docs"
                  title="Do-It-Now activities (gcp-demos)"
                  environment="web"
                  feedback-link="-">
    
      <google-codelab-step label="Overview" duration="0">
        <aside class="special"><p><strong>tl;dr</strong> hands-on &gt; demos &gt; slides</p>
</aside>
<p>The best way to learn something is try it yourself. So we&#39;ve turned a bunch of the demos our instructors do into <strong>Do-It-Now</strong> activities, where students can try each concept out in quick, bite-size activities.</p>
<p>If you are using these as part of an Instructor Led Training (ILT), make sure to listen to your instructor and coordinate your efforts with their direction. </p>


      </google-codelab-step>
    
      <google-codelab-step label="BigQuery Do-It-Nows" duration="0">
        <h2 is-upgraded><strong>Overview</strong><br></h2>
<ol type="1" start="1">
<li>We have 18 Do-It-Now activities for BigQuery concepts. </li>
<li>These activities are all prefixed with <strong>BigQuery</strong>.</li>
<li>Many of these activities will cost money</li>
</ol>
<aside class="warning"><p><strong>Warning</strong>: Do-It-Nows tagged with $ generate significant charges if run in your personal account. We assume that you are working in Qwiklabs-generated projects with Qwiklabs-provided accounts. You&#39;ve been warned</p>
</aside>
<h2 is-upgraded><strong>Sample data</strong><br></h2>
<ol type="1" start="4">
<li>Many of the activities use data in the <strong>roi-bq-demos.bq_demo</strong> dataset</li>
<li>Other activities rely on additional sample tables that need to be derived from the tables in the <strong>bq_demo</strong> dataset. You can use the directions found <a href="https://github.com/roitraining/gcp-demos/tree/master/bq-schema-demo" target="_blank">here</a> to generate the required tables.</li>
<li>There is a much smaller dataset which will work with the demos: <strong>roi-bq-demos.bq_demo_small</strong>. Queries will be much faster with this dataset, so aren&#39;t as effective at illustrating query speed benefits.</li>
</ol>


      </google-codelab-step>
    
      <google-codelab-step label="BigQuery - Wikipedia queries [$$]" duration="0">
        <h2 is-upgraded><strong>Setting up</strong></h2>
<ol type="1" start="1">
<li>Log into <strong>Qwiklabs</strong> and start the <strong>Data to Insights Lab</strong>.</li>
<li>Using the provided credentials, open the <strong>Google Cloud Console</strong>, and navigate to the <strong>BigQuery UI</strong>.</li>
<li>In a separate browser tab, open <a href="https://github.com/roitraining/gcp-demos/blob/master/bq-demos/wiki_queries.sql" target="_blank">https://github.com/roitraining/gcp-demos/blob/master/bq-demos/wiki_queries.sql</a>. </li>
</ol>
<h2 is-upgraded><strong>Running a query</strong></h2>
<ol type="1" start="4">
<li>Enter the query from the github file into the BigQuery code editor, and change the term you are searching for to whatever word you like.</li>
<li>Run the query. Check the <strong>Job Information</strong> pane and note the query execution time and the bytes processed.</li>
</ol>
<h2 is-upgraded>Feel the power!</h2>
<ol type="1" start="6">
<li>Modify your query, changing the table name from <code>1M</code> to <code>10M</code>. Rerun the query and note the job info.</li>
<li>Repeat the process with the <code>100M</code>, <code>1B</code>, <code>10B</code> and <code>100B</code> tables.</li>
</ol>
<aside class="warning"><p>For the <code>100B</code> table query, enter the query time into the chat window.</p>
</aside>
<aside class="special"><p>Some things to think about:</p>
<ul>
<li>You provisioned no servers</li>
<li>You wrote no Java or Python code</li>
<li>You processed 106B rows with regex comparisons and hundreds of thousands of aggregations in under a minute!</li>
</ul>
</aside>


      </google-codelab-step>
    
      <google-codelab-step label="BigQuery - Exploring projects, datasets, and tables []" duration="0">
        <h2 is-upgraded><strong>Setting up</strong></h2>
<ol type="1" start="1">
<li>Open the console</li>
<li>Go to <strong>BigQuery</strong> page</li>
<li>Expand your project. If working in Qwiklabs, note that there are no resources as yet</li>
</ol>
<h2 is-upgraded><strong>Starring projects</strong></h2>
<ol type="1" start="4">
<li>Star the <code>bigquery-samples</code> project by name</li>
<li>Star the  <code>bigquery-public-data</code> project by name</li>
<li>Star the  <code>roi-bq-demos</code> project by name</li>
<li>Star any additional projects suggested by your instructor</li>
</ol>
<h2 is-upgraded><strong>Exploring datasets</strong></h2>
<ol type="1" start="8">
<li>Expand <strong>bigquery-samples </strong>in the Explorer pane.</li>
<li>Note the datasets; expand one or two of the datasets. A dataset is a collection of assets (can be secured as a unit; lives in a specific location)</li>
<li>Click on <strong>wikipedia_benchmark</strong> in the <strong>Explorer</strong> pane; look at the metadata displayed in right pane.</li>
<li>Click on the three dot menu to the right of a dataset in <strong>Explorer</strong> and note the available actions</li>
</ol>
<h2 is-upgraded><strong>Creating a dataset</strong></h2>
<ol type="1" start="12">
<li>In your project, create a new dataset called <code>class</code></li>
</ol>
<h2 is-upgraded><strong>Exploring tables</strong></h2>
<ol type="1" start="13">
<li>Review tables in the <strong>bigquery-samples.wikipedia_benchmark</strong> dataset</li>
<li>Click on <strong>100B</strong> table</li>
<li>Review the table schema shown on the right</li>
<li>Look at table details</li>
<li>Look at preview data</li>
<li>Check out three dot menu next to the table name on the left</li>
</ol>
<aside class="warning"><p>If you&#39;re doing this activity as part of an ILT, enter the following into the chat window:</p>
<ul>
<li>FINISHED!</li>
</ul>
</aside>


      </google-codelab-step>
    
      <google-codelab-step label="BigQuery - Exploring views and jobs [$]" duration="0">
        <h2 is-upgraded><strong>Setting up</strong></h2>
<ol type="1" start="1">
<li>Make sure you have the <strong>BigQuery</strong> console open.</li>
<li>In a separate browser tab, open <a href="https://github.com/roitraining/gcp-demos/blob/master/bq-do-it-nows/views.sql" target="_blank">https://github.com/roitraining/gcp-demos/blob/master/bq-do-it-nows/views.sql</a> </li>
</ol>
<h2 is-upgraded><strong>Making the case for views</strong></h2>
<ol type="1" start="3">
<li>Enter the <code>query with subquery</code> query into the <strong>BigQuery</strong> editor</li>
<li>Review the query - what does it do?</li>
<li>Examine just the subquery</li>
<li>Run just the subquery and note results (CMD-e)</li>
<li>Next, run the whole query<br>a. It runs the subquery first, and generates an in-memory table<br>b. It then runs the outer query against the in-memory table<br>c. Run the query and check the results</li>
<li>Rather than using subqueries, you can use with clauses. This behaves effectively the same. Try running the <code>with clause</code> query in <strong>BigQuery</strong></li>
</ol>
<p>What if you like that subquery a lot, and would like to use it in many other queries? Rather than copy/paste over and over, you can create a view. A view is just a saved, shared subquery.</p>
<ol type="1" start="9">
<li>Run the <code>create view</code> query in <strong>BigQuery</strong></li>
<li>Check out the view in the UI</li>
<li>Now try running the <code>query view</code> query, which queries the view</li>
</ol>
<aside class="warning"><p>If you&#39;re doing this activity as part of an ILT, enter the following into the chat window:</p>
<ul>
<li>How much data is getting processed when you query the view?</li>
<li>Do you save time/money?</li>
</ul>
</aside>
<aside class="special"><p><strong>Why would you use views?</strong></p>
<ol type="1" start="1">
<li>To make sharing subqueries easier</li>
<li>To make your code more readable</li>
<li>To limit data shown to audience (though not securely)</li>
</ol>
</aside>
<h2 is-upgraded><strong>See the jobs you&#39;ve run</strong><br></h2>
<ol type="1" start="12">
<li>Click on the history links at the bottom of the page and review the queries that you&#39;ve run</li>
</ol>


      </google-codelab-step>
    
      <google-codelab-step label="BigQuery - Exploring routines [$]" duration="0">
        <h2 is-upgraded><strong>Setting up</strong></h2>
<ol type="1" start="1">
<li>Make sure you have the <strong>BigQuery</strong> console open.</li>
<li>In a separate browser tab, open <a href="https://github.com/roitraining/gcp-demos/blob/master/bq-do-it-nows/udfs.sql" target="_blank">https://github.com/roitraining/gcp-demos/blob/master/bq-do-it-nows/udfs.sql</a> </li>
</ol>
<h2 is-upgraded><strong>Messy numbers</strong></h2>
<ol type="1" start="3">
<li>Look at the <strong>messy_text</strong> table in the <strong>roi-bq-demos.bq_demo</strong> dataset; check out the data in the preview tab.</li>
<li>Run the <code>trim strings</code> query. What does it do? How does it do it?</li>
<li>Review and run the <code>create udf</code> query</li>
<li>Select the <strong>tidy_string</strong> function in the routines section of the <strong>Explorer</strong> pane; review the details.</li>
<li>Run the query with <code>query with SQL UDF</code> query</li>
</ol>
<h2 is-upgraded><strong>Getting numbers from text</strong></h2>
<ol type="1" start="8">
<li>Review the <strong>number_string</strong> table in the <strong>roi-bq-demos.bq_demo</strong> dataset; check out the data in the preview tab.</li>
<li>Review and run the <code>create javascript udf</code> query</li>
<li>Review the <strong>get_numbers</strong> UDF in the routines section</li>
<li>Run the <code>query with javascript udf</code> query</li>
<li>Look at documentation for stored procedures: <a href="https://cloud.google.com/bigquery/docs/procedures" target="_blank">https://cloud.google.com/bigquery/docs/procedures</a> </li>
</ol>
<aside class="warning"><p>If you&#39;re doing this activity as part of an ILT, enter the following into the chat window:</p>
<ul>
<li>FINISHED!</li>
</ul>
</aside>


      </google-codelab-step>
    
      <google-codelab-step label="BigQuery - Exploring the editor []" duration="0">
        <h2 is-upgraded><strong>Setting up</strong></h2>
<ol type="1" start="1">
<li>Make sure you have the <strong>BigQuery</strong> console open.</li>
</ol>
<h2 is-upgraded><strong>Taking the tour</strong></h2>
<ol type="1" start="2">
<li>Notice that you can have multiple tabs open</li>
<li>Write a query to find all CA customers from <strong>roi-bq-demos.bq_demo. </strong>Use tab to autocomplete things like SQL keywords and table references.</li>
<li>Add a comment at the top of the query using either # or â€“ and the beginning of comment. Try toggling the comment using <code>CMD-/</code></li>
<li>Copy/paste the contents of <a href="https://github.com/roitraining/gcp-demos/blob/master/bq-do-it-nows/udfs.sql" target="_blank">https://github.com/roitraining/gcp-demos/blob/master/bq-do-it-nows/udfs.sql</a>  into an editor tab</li>
<li>Select <code>OR REPLACE</code></li>
<li>Press <code>CTRL/CMD-D</code> several times to multi select</li>
<li>Hit backspace or delete to change all the lines</li>
<li>Click the shortcut button to get a list of shortcuts</li>
<li>Press <code>F1</code> (or right-click in editor tab and choose show command palette) to see more options (including making the font bigger!)</li>
</ol>
<aside class="warning"><p>If you&#39;re doing this activity as part of an ILT, enter the following into the chat window:</p>
<ul>
<li>FINISHED!</li>
</ul>
</aside>


      </google-codelab-step>
    
      <google-codelab-step label="BigQuery - Exploring caching [$]" duration="0">
        <h2 is-upgraded><strong>Setting up</strong></h2>
<ol type="1" start="1">
<li>Make sure you have the <strong>BigQuery</strong> console open.</li>
</ol>
<h2 is-upgraded><strong>Working with cache</strong></h2>
<ol type="1" start="2">
<li>Run this query:</li>
</ol>
<pre><code>select * from `roi-bq-demos.bq_demo.customer` where cust_state = &#34;AK&#34;</code></pre>
<ol type="1" start="3">
<li>Look at <strong>JOB INFORMATION</strong></li>
<li>Note the query  duration and bytes processed</li>
<li>Click on link for <strong>Destination table. </strong>This temp table has the results of your query and lasts for 24 hours</li>
<li>Re-run the query</li>
<li>Note duration and bytes processed</li>
<li>Disable cache and re-run query</li>
</ol>
<aside class="warning"><p>If you&#39;re doing this activity as part of an ILT, enter the following into the chat window:</p>
<ul>
<li>FINISHED!</li>
</ul>
</aside>


      </google-codelab-step>
    
      <google-codelab-step label="BigQuery - Exploring saved queries [$]" duration="0">
        <h2 is-upgraded><strong>Setting up</strong></h2>
<ol type="1" start="1">
<li>Make sure you have the <strong>BigQuery</strong> console open.</li>
</ol>
<h2 is-upgraded><strong>Working with saved queries</strong></h2>
<ol type="1" start="2">
<li>Write a query to find orders on one day in 2018 (from <code>roi-bq-demos.bq_demo.orders</code>)</li>
<li>Save the query</li>
<li>Close all the editor tabs</li>
<li>Click on your saved query in the Explorer panel</li>
<li>Run the query again</li>
</ol>
<aside class="warning"><p>If you&#39;re doing this activity as part of an ILT, share the query publicly and the link into the chat window</p>
</aside>


      </google-codelab-step>
    
      <google-codelab-step label="BigQuery - Time Travel [$]" duration="0">
        <h2 is-upgraded><strong>Setting up</strong></h2>
<ol type="1" start="1">
<li>Make sure you have the <strong>BigQuery</strong> console open</li>
<li>Open the Cloud Shell</li>
</ol>
<h2 is-upgraded><strong>Creating the time travel table</strong></h2>
<ol type="1" start="3">
<li>In a new browser tab, open <a href="https://github.com/roitraining/gcp-demos/blob/master/bq-do-it-nows/time_travel.sh" target="_blank">https://github.com/roitraining/gcp-demos/blob/master/bq-do-it-nows/time_travel.sh</a></li>
<li>Review the contents of the file</li>
</ol>
<aside class="special"><p>Here&#39;s what&#39;s happening:</p>
<ul>
<li>The <strong>first</strong> command uses the bq CLI tool to find all the January orders for CA customers, and writes order information into a new table</li>
<li>The <strong>second</strong> command notes the time at which the table was updated</li>
<li>The <strong>third</strong> command uses the bq CLI tool to find all the February orders for CA customers and appends those to the table</li>
<li>The <strong>last</strong> commands tell you when the table updates are done, and give you the target value for your timestamp search</li>
</ul>
</aside>
<ol type="1" start="5">
<li>Copy the contents of the file and paste them into your Cloud Shell terminal window.</li>
</ol>
<h2 is-upgraded><strong>Running queries against the current, fully populated table</strong></h2>
<ol type="1" start="6">
<li>In a new browser tab, open <a href="https://github.com/roitraining/gcp-demos/blob/master/bq-do-it-nows/time_travel.sql" target="_blank">https://github.com/roitraining/gcp-demos/blob/master/bq-do-it-nows/time_travel.sql</a>.</li>
<li>Run the <code>-- view up-to-date table</code> query. This should show you the total number of orders per month, with values for Jan. and Feb.</li>
</ol>
<h2 is-upgraded><strong>Running a time travel query, finding results from specific time</strong></h2>
<ol type="1" start="8">
<li>Copy the  <code>-- view table with only initial load</code>  query from the SQL file in Github and paste it into your BigQuery editor.</li>
<li>Replace <code>target</code> with the time travel target value that was output in your Cloud Shell window. It should look like this: <strong>1654541783</strong></li>
<li>Run the query. This should show you the total number of orders per month, but from the table as it looked after it&#39;s initial load when only January data was stored.</li>
</ol>
<h2 is-upgraded><strong>Restore a previous version of the table to a new table</strong></h2>
<ol type="1" start="11">
<li>Copy the  <code>-- create restoration table</code>  query from the SQL file in Github and paste it into your BigQuery editor.</li>
<li>Replace <code>target</code> with the time travel target value that was output in your Cloud Shell window. It should look like this: <strong>1654541783</strong></li>
<li>Run the query. One the table has been created, check out the Details and Preview data. Verify that only January orders exist.<br></li>
</ol>
<aside class="warning"><p>If you&#39;re doing this activity as part of an ILT, enter the following into the chat window:</p>
<ul>
<li>How many rows are in the time travel table?</li>
</ul>
</aside>
<aside class="special"><p>Some things to think about:</p>
<ul>
<li>Time travel window is configurable 2-7 days</li>
<li>Table snapshots are a new feature on top of time travel (see <a href="https://cloud.google.com/bigquery/docs/table-snapshots-intro" target="_blank">https://cloud.google.com/bigquery/docs/table-snapshots-intro</a><strong>)</strong></li>
</ul>
</aside>


      </google-codelab-step>
    
      <google-codelab-step label="BigQuery - Exploring wildcard tables [$]" duration="0">
        <h2 is-upgraded><strong>Setting up</strong></h2>
<ol type="1" start="1">
<li>Make sure you have the <strong>BigQuery</strong> console open.</li>
<li>Make sure you have the <code>bigquery-public-data.noaa_gsod</code> pinned.</li>
<li>In the Explorer pane, expand <strong>bigquery-public-data.noaa_gsod</strong>. </li>
</ol>
<aside class="special"><p>Why are there so many tables?</p>
</aside>
<h2 is-upgraded><strong>Working with sharded tables</strong></h2>
<ol type="1" start="4">
<li>Write a query that finds all the entries for <code>stn 038110</code> in <code>1929</code></li>
<li>How would you write a query that finds all the <code>03110</code> entries for <code>1929</code>, <code>1930</code>, <code>1931</code>?</li>
</ol>
<h2 is-upgraded><strong>Working with wildcard table queries</strong></h2>
<ol type="1" start="6">
<li>Review <a href="https://cloud.google.com/bigquery/docs/querying-wildcard-tables" target="_blank">https://cloud.google.com/bigquery/docs/querying-wildcard-tables</a> </li>
<li>Write a query that finds all the <code>038110</code> entries for <code>1929-1939</code> using a wildcard table</li>
<li>If you wanted to write a query to find <code>038110</code> entries in ALL the tables in the dataset?</li>
</ol>
<aside class="warning"><p>If you&#39;re doing this activity as part of an ILT, paste your query into the chat window</p>
</aside>


      </google-codelab-step>
    
      <google-codelab-step label="BigQuery - Exploring external tables [$]" duration="0">
        <h2 is-upgraded><strong>Setting up</strong></h2>
<ol type="1" start="1">
<li>Make sure you have the <strong>BigQuery</strong> console open.</li>
<li>In a new browser tab, open <a href="https://github.com/roitraining/gcp-demos/blob/master/bq-do-it-nows/bq_hive.sql" target="_blank">https://github.com/roitraining/gcp-demos/blob/master/bq-do-it-nows/bq_hive.sql</a> </li>
<li>In another new browser tab, open <a href="https://console.cloud.google.com/storage/browser/jwd-gcp-demos/orders_partitioned" target="_blank">https://console.cloud.google.com/storage/browser/jwd-gcp-demos/orders_partitioned</a></li>
</ol>
<aside class="special"><p><strong>Questions</strong>: </p>
<ul>
<li>How many &#34;directories&#34; are there in the bucket?</li>
<li>How many files in each directory?</li>
<li>What does the naming of the directories imply?</li>
</ul>
<p>What you are seeing is a Hive-partitioned dataset living in your Data Lake (within GCS), with each file being a Parquet file.</p>
</aside>
<h2 is-upgraded><strong>Create an external table</strong></h2>
<ol type="1" start="4">
<li>In the BigQuery UI&#39;s <strong>Explorer</strong> pane, select your dataset </li>
<li>From three-dot menu, select <strong>create table</strong></li>
<li>In <strong>Create table from</strong>, select <strong>Google Cloud Storage</strong></li>
<li>In <strong>Select file...</strong> enter <code>jwd-gcp-demos/orders_partitioned/*</code></li>
<li>In <strong>File format</strong> select <strong>parquet</strong></li>
<li>Check <strong>Source data partitioning</strong></li>
<li>In <strong>Select Source...</strong> enter <code>gs://jwd-gcp-demos/orders_partitioned/</code></li>
<li>In <strong>Table</strong>, enter <code>ext_part</code> </li>
<li>In <strong>Table type</strong> select <strong>External table</strong></li>
<li>In <strong>Schema</strong>, select <strong>Auto detect</strong></li>
<li><strong>Click CREATE TABLE</strong></li>
<li>Check your table details</li>
</ol>
<h2 is-upgraded><strong>Query the external table</strong></h2>
<ol type="1" start="16">
<li>Run the <code>query the external table</code> query</li>
</ol>
<aside class="special"><p>How many rows are returned?</p>
</aside>
<ol type="1" start="17">
<li>Run the <code>query external table with where clause</code> query;</li>
</ol>
<aside class="special"><p> Review the execution details; how much data was processed?</p>
</aside>
<ol type="1" start="18">
<li>Run the <code>query external table on partition</code> query; </li>
</ol>
<aside class="special"><p> Review the execution details; how much data was processed? Why was it lower?</p>
</aside>
<aside class="warning"><p>If you&#39;re doing this activity as part of an ILT, enter the following into the chat window:</p>
<ul>
<li>FINISHED!</li>
</ul>
</aside>


      </google-codelab-step>
    
      <google-codelab-step label="BigQuery - Exploring normalized data and joins [$$]" duration="0">
        <h2 is-upgraded><strong>Setting up</strong></h2>
<ol type="1" start="1">
<li>Make sure you have the <strong>BigQuery</strong> console open.</li>
<li>In a new browser tab, open <a href="https://github.com/roitraining/gcp-demos/blob/master/bq-schema-demo/norm_query.sql" target="_blank">https://github.com/roitraining/gcp-demos/blob/master/bq-schema-demo/norm_query.sql</a></li>
<li>Copy the query into the BQ query editor</li>
<li>Replace all instances of <strong>&lt;project-id&gt;</strong> with <code>roi-bq-demos</code> (or whatever project your instructor directs you to use)</li>
</ol>
<h2 is-upgraded><strong>Try out query with joins</strong></h2>
<ol type="1" start="5">
<li>Run the query and review the <strong>Job Information</strong> and <strong>Execution Details</strong></li>
</ol>
<aside class="special"><p>Some things to think about:</p>
<ul>
<li>How much data was processed?</li>
<li>How long did it take</li>
<li>How many slot seconds were consumed?</li>
<li>How much data was shuffled?</li>
<li>Did it work?</li>
<li>Why are we using the with clause here?</li>
<li>What do you think about the performance?</li>
</ul>
</aside>
<aside class="warning"><p>If you&#39;re doing this activity as part of an ILT, enter the following into the chat window:</p>
<ul>
<li>How long did your query take to run?</li>
</ul>
</aside>


      </google-codelab-step>
    
      <google-codelab-step label="BigQuery - Exploring denormalized data [$$]" duration="0">
        <h2 is-upgraded><strong>Setting up</strong></h2>
<ol type="1" start="1">
<li>Make sure you have the <strong>BigQuery</strong> console open.</li>
<li>View the denorm table in the project shared with you by your instructor</li>
</ol>
<aside class="special"><p>Some things to think about:</p>
<ul>
<li>How much more data is in this table vs. the normalized tables?</li>
<li>What much more does it cost to store this data?</li>
</ul>
</aside>
<ol type="1" start="3">
<li>In a new browser tab, open <a href="https://github.com/roitraining/gcp-demos/blob/master/bq-schema-demo/denorm_query.sql" target="_blank">https://github.com/roitraining/gcp-demos/blob/master/bq-schema-demo/denorm_query.sql</a> </li>
<li>Copy the query into the BQ query editor</li>
<li>Replace <strong>&lt;project-id&gt;</strong> with the instructor&#39;s project name</li>
</ol>
<h2 is-upgraded><strong>Try out query with joins</strong></h2>
<ol type="1" start="6">
<li>Run the query and review the <strong>Job Information</strong> and <strong>Execution Details</strong></li>
</ol>
<aside class="special"><p>Some things to think about:</p>
<ul>
<li>How much data was processed?</li>
<li>How long did it take?</li>
<li>How many slot seconds were consumed?</li>
<li>How much data was shuffled?</li>
<li>Did it work?</li>
<li>Why was it faster?</li>
<li>Is the price/performance tradeoff worthwhile?</li>
</ul>
</aside>
<aside class="warning"><p>If you&#39;re doing this activity as part of an ILT, enter the following into the chat window:</p>
<ul>
<li>How much faster was this query than the last?</li>
</ul>
</aside>


      </google-codelab-step>
    
      <google-codelab-step label="BigQuery - Exploring arrays [$]" duration="0">
        <h2 is-upgraded><strong>Setting up</strong></h2>
<ol type="1" start="1">
<li>Make sure you have the <strong>BigQuery</strong> console open.</li>
<li>In a new browser window, open <a href="https://github.com/roitraining/gcp-demos/blob/master/bq-do-it-nows/arrays.sql" target="_blank">https://github.com/roitraining/gcp-demos/blob/master/bq-do-it-nows/arrays.sql</a></li>
</ol>
<h2 is-upgraded><strong>Populating Arrays</strong></h2>
<ol type="1" start="3">
<li>Read and run the <code>populate arrays explicitly</code> query, and review the results</li>
<li>Read and run the <code>populate arrays using array_agg</code> query, and review the results</li>
</ol>
<aside class="special"><p>Some things to think about:</p>
<ul>
<li>How is the array column being generated?</li>
</ul>
</aside>
<h2 is-upgraded><strong>Array lengths</strong></h2>
<ol type="1" start="5">
<li>In the Explorer pane, drill down to<strong> bigquery-public-data.github_repos.commits</strong>. </li>
</ol>
<aside class="special"><p>Some things to think about:</p>
<ul>
<li>How many rows are there? </li>
<li>What is the <strong>difference</strong> column?</li>
</ul>
</aside>
<ol type="1" start="6">
<li>Read and run the <code>report array length</code> query, and review the results. </li>
<li>Write a query to find all the rows where the length of the <strong>difference</strong> array is equal to <strong>five</strong> (hint, you can use the <code>find by array length</code> query from the git file).</li>
</ol>
<h2 is-upgraded><strong>UNNEST</strong></h2>
<ol type="1" start="8">
<li>Review and run the <code>select basic array from array</code> query. Review the results.</li>
<li>Click on the <strong>JSON</strong> tab in the <strong>Query results</strong> area, and note the structure of the results. There&#39;s an array with a single row object. That object has a single column, which is a four-element array.</li>
<li>Review and run the <code>select table from array</code> query. Review the results.</li>
<li>Click on the <strong>JSON</strong> tab in the <strong>Query results</strong> area, and note the structure of the results. There are four rows, each with one column which is a scalar value. <code>Unnest</code> flattens the array into a table.</li>
<li>Review and run the <code>calculate average of array</code> query. </li>
</ol>
<aside class="special"><p>Some things to think about:</p>
<ul>
<li>What is the average? </li>
<li>How is this query working?</li>
</ul>
</aside>
<ol type="1" start="13">
<li>Review and run the <code>basic correlated cross join</code> query. The CTE at the top is just creating an initial <code>arrays</code> table with two rows and two columns. Review the standard results output and the JSON output.</li>
</ol>
<aside class="special"><p>Some things to think about:</p>
<ul>
<li>What is this query doing?</li>
<li>Why might you do this?</li>
</ul>
</aside>
<ol type="1" start="14">
<li>Review and run the <code>comma correlated cross join</code> query.</li>
</ol>
<aside class="special"><p>Some things to think about:</p>
<ul>
<li>How does this differ from the previous query?</li>
<li>Are the results the same?</li>
</ul>
</aside>
<ol type="1" start="15">
<li>It turns out, that if you&#39;re doing a correlated cross join, you don&#39;t even need to explicitly do the <code>UNNEST</code>, it&#39;s done for you implicitly. Review and run the <code>comma implicit unnest</code> query.</li>
</ol>
<aside class="special"><p>Some things to think about:</p>
<ul>
<li>How does this differ from the previous query?</li>
<li>Are the results the same?</li>
</ul>
</aside>
<h2 is-upgraded><strong>Querying on array contents</strong></h2>
<ol type="1" start="16">
<li>Review and run the <code>-- find row where num_array contains 2 - take 1</code> query. Review the results.</li>
</ol>
<aside class="special"><p>Some things to think about:</p>
<ul>
<li>How does this query find the rows with desired value?</li>
<li>What might be a problem with this?</li>
</ul>
</aside>
<ol type="1" start="17">
<li>Edit the query, modifying the CTE so that the first row in the arrays table is [2, 2, 3, 4]. Re-run the query and note the results.</li>
</ol>
<aside class="special"><p>Some things to think about:</p>
<ul>
<li>Did it do what you expected?</li>
<li>How could you ensure it only returns one copy of any given row, no matter how many times the target element value occurs in the array? <em>Don&#39;t hurt yourself, we&#39;ll come back to this in a minute</em>.</li>
</ul>
</aside>
<ol type="1" start="18">
<li>Edit the query to search for rows that have an 8 in the array. Run the query and review the results? Are they correct?</li>
<li>Run the <code>-- find row where num_array contains 2 - take 2</code> query. </li>
</ol>
<aside class="special"><p>Some things to think about:</p>
<ul>
<li>Do you understand how the query works?</li>
<li>Is row 1 returned more than once?</li>
<li>Why?</li>
</ul>
</aside>
<ol type="1" start="20">
<li>Run the <code>-- find row where num_array contains 2 - take 3</code> query. </li>
</ol>
<aside class="special"><p>Some things to think about:</p>
<ul>
<li>Do you understand how the query works?</li>
<li>Is row 1 returned more than once?</li>
<li>Why?</li>
</ul>
</aside>
<p>All three of these queries return the same results, but there are differences in performance on large datasets. Let&#39;s explore that.</p>
<ol type="1" start="21">
<li>Run each of the <code>find commits that...</code> queries, noting the time taken for each to run.</li>
</ol>
<aside class="special"><p>Some things to think about:</p>
<ul>
<li>Which one is fastest?</li>
<li>Why?</li>
</ul>
</aside>
<aside class="warning"><p>If you&#39;re doing this activity as part of an ILT, enter the following into the chat window:</p>
<ul>
<li>FINISHED!</li>
</ul>
</aside>


      </google-codelab-step>
    
      <google-codelab-step label="BigQuery - Exploring nested data [$$]" duration="0">
        <h2 is-upgraded><strong>Setting up</strong></h2>
<ol type="1" start="1">
<li>Make sure you have the <strong>BigQuery</strong> console open.</li>
<li>View the <strong>nested_once</strong> table in your instructor&#39;s project</li>
</ol>
<aside class="special"><p>Some things to think about:</p>
<ul>
<li>Which col is repeated?</li>
<li>How many line items are there per order?</li>
<li>How much data does the table store?</li>
<li>How does this compare to the denorm table?</li>
</ul>
</aside>
<ol type="1" start="3">
<li>In a new browser window, open <a href="https://github.com/roitraining/gcp-demos/blob/master/bq-schema-demo/nested_queries.sql" target="_blank">https://github.com/roitraining/gcp-demos/blob/master/bq-schema-demo/nested_queries.sql</a></li>
</ol>
<h2 is-upgraded><strong>Querying the nested table</strong></h2>
<ol type="1" start="4">
<li>Read and run the <code>find sales/zip for march from nested_once table</code> query (replace <code><project-id></code> with the instructor&#39;s project name)</li>
</ol>
<aside class="special"><p>Some things to think about:</p>
<ul>
<li>How fast was it?</li>
<li>How does this compare to normalized and denorm queries?</li>
<li>How much data was processed?</li>
</ul>
</aside>
<aside class="warning"><p>If you&#39;re doing this activity as part of an ILT, enter the following into the chat window:</p>
<ul>
<li>How much faster was this query than the normalized query?</li>
</ul>
</aside>


      </google-codelab-step>
    
      <google-codelab-step label="BigQuery - Exploring partitioned tables [$]" duration="0">
        <h2 is-upgraded><strong>Setting up</strong></h2>
<ol type="1" start="1">
<li>Make sure you have the <strong>BigQuery</strong> console open.</li>
<li>Review the <strong>table_nested_partitioned</strong> table in your instructor&#39;s project</li>
</ol>
<aside class="special"><p>Some things to think about:</p>
<ul>
<li>What column is it partitioned on?</li>
</ul>
</aside>
<ol type="1" start="3">
<li>In a new browser window, open <a href="https://github.com/roitraining/gcp-demos/blob/master/bq-schema-demo/nested_queries.sql" target="_blank">https://github.com/roitraining/gcp-demos/blob/master/bq-schema-demo/nested_queries.sql</a></li>
</ol>
<h2 is-upgraded><strong>Querying the partitioned table</strong></h2>
<ol type="1" start="4">
<li>Read and run the <code>find sales/zip for march from nested/partitioned table</code> query (replace <code><project-id></code> with the instructor&#39;s project name)</li>
</ol>
<aside class="special"><p>Some things to think about:</p>
<ul>
<li>How fast was it?</li>
<li>How much data was processed?</li>
<li>Why?</li>
</ul>
</aside>
<aside class="warning"><p>If you&#39;re doing this activity as part of an ILT, enter the following into the chat window:</p>
<ul>
<li>FINISHED!</li>
</ul>
</aside>


      </google-codelab-step>
    
      <google-codelab-step label="BigQuery - Exploring clustered tables [$$]" duration="0">
        <h2 is-upgraded><strong>Setting up</strong></h2>
<ol type="1" start="1">
<li>Make sure you have the <strong>BigQuery</strong> console open.</li>
<li>Review the <strong>table_nested_partitioned_clustered</strong> table in your instructor&#39;s project</li>
</ol>
<aside class="special"><p>Some things to think about:</p>
<ul>
<li>What column is it clustered on?</li>
</ul>
</aside>
<ol type="1" start="3">
<li>In a new browser window, open <a href="https://github.com/roitraining/gcp-demos/blob/master/bq-schema-demo/nested_queries.sql" target="_blank">https://github.com/roitraining/gcp-demos/blob/master/bq-schema-demo/nested_queries.sql</a></li>
</ol>
<h2 is-upgraded><strong>Querying the partitioned table</strong></h2>
<ol type="1" start="4">
<li>Find the total sales for the 8754 zip code by running the <code>find sales for 6 months in 8754 from nested</code> query (replace <code><project-id></code> with the instructor&#39;s project name). Note the duration and data processed.</li>
<li>Run the <code>find for 6 months in 8754 from nested/partitioned query</code> (replace <code><project-id></code> with the instructor&#39;s project name) and note the duration and data processed.</li>
<li>Run the <code>find for 6 months in 8754 from nested/partitioned/clustered</code> query (replace <code><project-id></code> with the instructor&#39;s project name) and note the duration and data processed.</li>
</ol>
<aside class="warning"><p>If you&#39;re doing this activity as part of an ILT, enter the following into the chat window:</p>
<ul>
<li>How much faster was the clustered/partitioned table compared to the table with no partitioning or clustering?</li>
</ul>
</aside>


      </google-codelab-step>
    
      <google-codelab-step label="BigQuery - Exploring derived tables [$$]" duration="0">
        <h2 is-upgraded><strong>Setting up</strong></h2>
<ol type="1" start="1">
<li>Make sure you have the <strong>BigQuery</strong> console open.</li>
</ol>
<h2 is-upgraded><strong>Querying the partitioned table</strong></h2>
<ol type="1" start="2">
<li>Write and run a query to find all the March 2018 orders from the instructor&#39;s nested/repeated table, projecting all the columns except the customer email and phone number, and storing the results in a derived table in your <code>class</code> dataset.</li>
<li>Write and run a query to sum sales for AK customers orders in March 2018, using the full nested/repeated table. Note the query duration and bytes processed.</li>
<li>Write and run a query to sum sales for AK customers orders in March 2018, using the derived table. Note the query duration and bytes processed.</li>
</ol>
<aside class="special"><p>Some things to think about:</p>
<ul>
<li>How much faster was querying the derived table?</li>
<li>How much cheaper was querying the derive table?</li>
<li>Consider the impact if AK analysts queried AK orders 100s of times per day</li>
</ul>
</aside>
<ol type="1" start="5">
<li>Schedule the query to run daily at 12.01am, overwriting the previous contents of the derived table.</li>
</ol>
<aside class="special"><p>Some things to think about:</p>
<ul>
<li>What are some downsides of derived tables?</li>
<li>How else might you achieve similar performance using the full table?</li>
</ul>
</aside>
<aside class="warning"><p>If you&#39;re doing this activity as part of an ILT, enter the following into the chat window:</p>
<ul>
<li>FINISHED!</li>
</ul>
</aside>


      </google-codelab-step>
    
      <google-codelab-step label="BigQuery - Exploring materialized views [$]" duration="0">
        <h2 is-upgraded><strong>Setting up</strong></h2>
<ol type="1" start="1">
<li>Make sure you have the <strong>BigQuery</strong> console open.</li>
<li>Review the <strong>roi-bq-demos.bq_demo.order_mv</strong> materialized view<br></li>
</ol>
<aside class="special"><p>Some things to think about:</p>
<ul>
<li>What columns are projected?</li>
<li>What is the view size?</li>
<li>How many rows are materialized</li>
<li>How often does the view refresh?</li>
<li>What is the view showing?</li>
</ul>
</aside>
<ol type="1" start="3">
<li>In a new browser window, open <a href="https://github.com/roitraining/gcp-demos/blob/master/bq-do-it-nows/mv.sql" target="_blank">https://github.com/roitraining/gcp-demos/blob/master/bq-do-it-nows/mv.sql</a></li>
</ol>
<h2 is-upgraded><strong>Querying the materialized view</strong></h2>
<ol type="1" start="4">
<li>Run the  <code>-- query against original tables...</code> query. </li>
</ol>
<aside class="special"><p>Some things to think about:</p>
<ul>
<li>How much data was processed?</li>
<li>How much data was billed?</li>
</ul>
</aside>
<h2 is-upgraded><strong>Querying the original tables</strong></h2>
<ol type="1" start="5">
<li>Run the <code>-- query against original tables...</code> query.</li>
</ol>
<aside class="special"><p>Some things to think about:</p>
<ul>
<li>What are some downsides of derived tables?</li>
<li>How else might you achieve similar performance using the full table?</li>
<li>Is this what you expected?</li>
<li>How would it be different if you ran this query and there was no materialized view?</li>
</ul>
</aside>
<aside class="warning"><p>If you&#39;re doing this activity as part of an ILT, enter the following into the chat window:</p>
<ul>
<li>FINISHED!</li>
</ul>
</aside>


      </google-codelab-step>
    
      <google-codelab-step label="BigQuery - Approximate aggregation functions [$$]" duration="0">
        <h2 is-upgraded><strong>Setting up</strong></h2>
<ol type="1" start="1">
<li>Make sure you have the <strong>BigQuery</strong> console open.</li>
<li>In a new browser window, open <a href="https://github.com/roitraining/gcp-demos/blob/master/bq-do-it-nows/approx.sql" target="_blank">https://github.com/roitraining/gcp-demos/blob/master/bq-do-it-nows/approx.sql</a></li>
</ol>
<h2 is-upgraded><strong>Run exact and approx queries side-by-side</strong></h2>
<ol type="1" start="3">
<li>Run the <code>-- First query - exact query</code> in one editor tab. This query will find the number of unique article titles in the 106B row wikipedia table</li>
<li>Open a 2nd editor tab, and run the <code>-- Second query - approx</code> query. This will approximate the number of unique article titles in the 106B row wikipedia table.</li>
</ol>
<h2 is-upgraded><strong>Compare results</strong></h2>
<ol type="1" start="5">
<li>Calculate the % difference in query execution time between the two queries</li>
<li>Calculate the % difference in reported number of unique titles </li>
</ol>
<aside class="warning"><p>If you&#39;re doing this activity as part of an ILT, enter the following into the chat window:</p>
<ul>
<li>Query time difference</li>
<li>% error in approximation</li>
</ul>
</aside>


      </google-codelab-step>
    
      <google-codelab-step label="Miscellaneous Data Engineering Do-It-Nows" duration="0">
        <aside class="warning"><p><strong>Warning</strong>: Do-It-Nows tagged with $ generate significant charges if run in your personal account. We assume that you are working in Qwiklabs-generated projects with Qwiklabs-provided accounts. You&#39;ve been warned</p>
</aside>
<p><br>The following activities cover a range of relevant Data Engineering topics. Enjoy!</p>


      </google-codelab-step>
    
      <google-codelab-step label="DE - Dataflow Streaming with Python [$]" duration="0">
        <h2 is-upgraded><strong>1. Overview</strong></h2>
<p>This activity is intended to illustrate a variety of techniques, including:</p>
<p><strong>Managing and using PubSub with Python</strong></p>
<ul>
<li>Creating topics and subscriptions</li>
<li>Creating bytestring message bodies</li>
<li>Sending messages</li>
</ul>
<p><strong>Various BEAM tricks when processing streams of data</strong></p>
<ul>
<li>Decoding bytestring message bodies</li>
<li>Using one branch for writing each event into a BigQuery table</li>
<li>Using a second branch for aggregating rows into windows and writing windows to BigQuery</li>
<li>Writing nested/repeated data from BEAM to BigQuery</li>
<li>Reading the end of window time</li>
</ul>
<h2 is-upgraded>2. <strong>Setting up</strong></h2>
<ol type="1" start="1">
<li>Open the Google Cloud console</li>
<li>Activate Cloud Shell</li>
<li>Click the button to open Cloud Shell in a new browser window</li>
<li>Clone the <strong>gcp-demos</strong> repository into Cloud Shell with the following command:</li>
</ol>
<pre>git clone https://github.com/roitraining/gcp-demos.git
cd gcp-demos/dflow-bq-stream-python</pre>
<ol type="1" start="5">
<li>Run the <code>setup.sh</code> script, providing the name of the service account you want the demo code to use. For example (with <code>demo-sa</code> as the service account name):</li>
</ol>
<pre>. ./setup.sh demo-sa</pre>
<ol type="1" start="6">
<li>Take a few minutes to review and understand the setup script. The diagram below indicates what&#39;s happening in the script.</li>
</ol>
<h2 is-upgraded><img style="width: 624.00px" src="img/e4b52eedaff69ff5.png"></h2>
<h2 is-upgraded>3. <strong>Starting the pipeline</strong></h2>
<ol type="1" start="7">
<li>Make sure that you are in the <strong>dflow-bq-stream-python </strong>directory in your Cloud Shell window.</li>
<li>Deploy the Dataflow job with the follow command (you&#39;ll review the code in a minute):</li>
</ol>
<pre>python3 process_events.py \
--runner DataflowRunner \
--region us-central1 \
--project $PROJECT_ID \
--staging_location gs://$PROJECT_ID-dflow-demo/ \
--temp_location gs://$PROJECT_ID-dflow-demo/</pre>
<h2 is-upgraded><strong>4. Starting the event stream</strong></h2>
<ol type="1" start="9">
<li>Run the following command to start sending messages:</li>
</ol>
<pre>python3 send_events.py \
    --project_id=$PROJECT_ID</pre>
<h2 is-upgraded><strong>5. Understanding the code</strong></h2>
<ol type="1" start="10">
<li>In a new browser tab, open <a href="https://github.com/roitraining/gcp-demos/blob/master/dflow-bq-stream-python/send_events.py" target="_blank">https://github.com/roitraining/gcp-demos/blob/master/bq-do-it-nows/dflow-bq-stream-python/send_events.py</a> </li>
<li>Take a few minutes to review and understand the code. The diagram below highlights some key features:</li>
</ol>
<p class="image-container"><img style="width: 624.00px" src="img/c2f8eeefc77bc843.png"></p>
<ol type="1" start="12">
<li>Open <a href="https://github.com/roitraining/gcp-demos/blob/master/dflow-bq-stream-python/process_events.py" target="_blank">https://github.com/roitraining/gcp-demos/blob/master/bq-do-it-nows/dflow-bq-stream-python/process_events.py</a> </li>
<li>Take a few minutes to review and understand the code. The diagrams below highlight some key features</li>
</ol>
<h2 is-upgraded><img style="width: 624.00px" src="img/2072fd183685cee3.png"></h2>
<h2 is-upgraded><img style="width: 624.00px" src="img/f4db34e38b750e09.png"></h2>
<h2 is-upgraded><strong>7. Check out the results</strong></h2>
<ol type="1" start="14">
<li>In the console, go to <strong>Dataflow</strong> and click on the running job.</li>
<li>Click on the top node of the pipeline diagram. Wait until you see metrics showing the number of received messages on the right-hand side (it takes a while for the cluster to spin up and start processing messages).</li>
<li>Explore the pipeline and the execution metrics in Dataflow.</li>
<li>In the console, go to <strong>BigQuery</strong> and explore your new <strong>dflow_demo</strong> dataset. Check out the <strong>DETAILS</strong> and <strong>PREVIEW</strong> section for both of the tables in that dataset. Note that the nested table has one row per window, with an array of structs, each struct representing one message for that window. Note also that the <strong>DETAILS</strong> section shows the rows in in the streaming buffer and not the BigQuery storage service.</li>
</ol>
<h2 is-upgraded>8. <strong>Clean up</strong></h2>
<ol type="1" start="18">
<li>Stop the Dataflow job via the console</li>
<li>Stop the sending of messages by closing the Cloud Shell window</li>
<li>Delete the PubSub topic and subscription</li>
<li>Delete the BigQuery dataset</li>
</ol>
<aside class="warning"><p>If you&#39;re doing this activity as part of an ILT, enter the following into the chat window:</p>
<ul>
<li>FINISHED!</li>
</ul>
</aside>


      </google-codelab-step>
    
  </google-codelab>

  <script src="https://storage.googleapis.com/codelab-elements-tmp/native-shim.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements-tmp/custom-elements.min.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements-tmp/prettify.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements-tmp/codelab-elements.js"></script>
  <script src="//support.google.com/inapp/api.js"></script>

</body>
</html>
